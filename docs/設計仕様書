import os
import socket
import datetime
import json
import requests  # HTTPリクエスト送信用ライブラリ

def get_startup_info():
    """
    PCの起動時に必要な情報を取得し、辞書形式で返す関数。
    """
    # ホスト名を取得してPC固有IDとして利用
    pc_id = socket.gethostname()

    # 環境変数からユーザー名を取得（取得できなければ "unknown" を返す）
    user_account = os.environ.get("USERNAME", "unknown")

    # 現在の日時を取得し、ログオン時刻としてフォーマット
    now = datetime.datetime.now()
    start_time = now.strftime("%Y-%m-%d %H:%M:%S")

    # 曜日を短縮形で取得（例: "Mon", "Tue", "Wed", ...）
    weekday = now.strftime("%a")

    # 収集した各情報を辞書にまとめる。シャットダウン時刻は後で更新するので空文字、
    # session_typeは「normal」（通常起動）を初期値、durationは0とする。
    data = {
        "pc_id": pc_id,
        "user_account": user_account,
        "start_time": start_time,
        "weekday": weekday,
        "shutdown_time": "",
        "session_type": "normal",
        "duration": 0
    }
    return data

def send_log(data):
    """
    取得したログデータをJSON形式に変換し、HTTP POSTリクエストで送信する関数。
    現段階ではサンプルURLが設定されているので、後で実際のURLに変更する。
    """
    # サンプルURL（後で実際のサーバURLに変更する）
    url = "https://yourserver.example.com/api/record"
    headers = {"Content-Type": "application/json"}

    try:
        response = requests.post(url, data=json.dumps(data), headers=headers)
        if response.status_code == 200:
            print("Log sent successfully.")
        else:
            print("Failed to send log:", response.status_code, response.text)
    except Exception as e:
        print("Exception occurred while sending log:", str(e))

if __name__ == "__main__":
    # 起動時の情報を取得
    startup_info = get_startup_info()
    print("Startup info:", startup_info)

    # 情報を中央への送信（現段階ではサンプルURLに送信）
    send_log(startup_info)
