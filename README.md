# PCActivityTracker

![Project Banner](https://via.placeholder.com/800x200?text=PCActivityTracker)

PCActivityTrackerは、複数のWindows PCにおける起動・ログオンおよびシャットダウン／中断イベントを自動的に記録し、中央のSQLiteデータベースに集約する革新的なシステムです。
これにより、各PCの利用状況を簡単かつ正確に把握できるため、システムの稼働状況や効果的なリソース管理が可能になります。

---

## 特徴

- **自動ログ収集**
  起動時とシャットダウン時に、それぞれのPCから自動でイベント情報が収集されます。
  ・PCのホスト名、ログオンユーザー、起動/終了時刻、曜日が記録され、利用時間も自動計算されます。

- **ネットワーク共有対応**
  ネットワーク上の共有フォルダに配置されたSQLiteデータベースにログを記録するため、複数のPCからのデータ集約が可能です。
  ネットワーク接続待機機能により、接続未確立時も安全にログが記録されます。

- **堅牢な再試行ロジック**
  同時アクセスによる「database is locked」エラー発生時には、指定された再試行回数内でランダムジッターを加えながら自動的に再試行を実施し、データの確実な保存を実現します。

- **柔軟な設定管理**
  外部設定ファイル (`config.ini`) により、データベースパス、再試行設定、タイムアウト、そしてコンソール表示の切替などが簡単にカスタマイズ可能です。

- **EXE化による配布**
  PyInstaller を利用してEXE化すれば、各PCにPython環境がなくても実行可能なスタンドアロンアプリとして配布・導入が可能です。

---

## ディレクトリ構成

```
PCActivityTracker/
├── README.md              # プロジェクトの概要、機能、インストール手順等をまとめたドキュメント
├── requirements.txt       # 必要なPythonライブラリ一覧
├── central_db_setup/
│   └── init_db.py         # 中央データベースの初期化用スクリプト
├── docs/
│   └── 設計仕様書.txt      # 詳細なシステム設計書・運用マニュアル
├── pc_client/
│   ├── config.ini         # 外部設定ファイル（データベースパス、再試行設定、コンソール表示設定等）
│   ├── startup.py         # PC起動時に実行されるログ収集スクリプト
│   ├── shutdown.py        # PCシャットダウン時に実行されるログ更新スクリプト
│   └── utils.py           # 共通ユーティリティ関数群
└── pc_server_test/        # （任意）サーバー側テスト用スクリプト
```

---

## インストール手順

1. **リポジトリのクローン**
   GitHubからリポジトリをクローンします：
   ```bash
   git clone https://github.com/kuroronrobins/PCActivityTracker.git
   ```

2. **依存ライブラリのインストール**
   プロジェクトルートで以下を実行し、必要ライブラリをインストールします：
   ```bash
   pip install -r requirements.txt
   ```

3. **設定ファイルの編集**
   `pc_client/config.ini` を開き、ネットワーク共有上のデータベースパスや再試行回数、タイムアウト、コンソール表示切替（debugモード）などを環境に合わせて設定します。

4. **データベースの初期化**
   `central_db_setup/init_db.py` を実行して、中央データベースのテーブル（session_logs）が正しく作成されているか確認してください。

5. **EXE化（オプション）**
   PyInstallerを使用して、`startup.py` と `shutdown.py` をそれぞれEXE化します。
   例：
   ```bash
   pyinstaller --onefile --noconsole pc_client/startup.py
   pyinstaller --onefile --noconsole pc_client/shutdown.py
   ```
   ※ 配布時にはEXEと同じディレクトリに `config.ini` を配置してください。

6. ## 自動実行設定

PCActivityTracker の効果的な運用のため、PC起動時およびシャットダウン時に各スクリプト（startup.exe、shutdown.exe）を自動実行する設定が推奨されます。設定方法は、利用環境に応じて「タスクスケジューラ」と「グループポリシー」の2パターンがあります。

### 1. タスクスケジューラを利用する方法 (Windows Home 向け)

Windows Home 環境ではグループポリシーが利用できないため、タスクスケジューラを使用して自動実行を設定します。以下は手順の概要です。

1. **タスクスケジューラの起動:**
   スタートメニューから「タスク スケジューラ」を検索して起動します。

2. **新しいタスクの作成:**
   右側の「タスクの作成」をクリックします。
   - **全般タブ:** タスク名を「PCActivityTracker Startup」や「PCActivityTracker Shutdown」など適宜入力し、実行時のユーザー権限を「最上位の特権で実行する」にチェックします。
   - **トリガータブ:**
     「新規」ボタンをクリックし、以下のようなトリガーを設定します。
     - 起動スクリプトの場合: 「ログオン時」または「コンピュータの起動時」を選択します。
     - 終了スクリプトの場合: 「ユーザーのログオフ時」または「シャットダウンイベント」を選択します。
   - **操作タブ:**
     「新規」ボタンをクリックし、起動スクリプトの場合は「プログラムの開始」に対して、EXEファイル（例：`C:\Program Files\PCActivityTracker\startup.exe`）のパスを指定します。
     シャットダウンスクリプトの場合も同様に、`shutdown.exe` のパスを指定します。
   - **条件/設定タブ:**
     必要に応じて、電源オプションや実行の優先度などを設定します。

3. **タスクの保存とテスト:**
   設定完了後、タスクを保存し、タスクスケジューラの「タスクの実行」を使って動作確認を行います。

### 2. グループポリシーを利用する方法 (Windows Professional 向け)

Windows Professional 環境ではグループポリシーを活用し、シャットダウンスクリプトを自動実行させる方法が利用できます。以下は手順の概要です。

1. **グループポリシーエディターの起動:**
   Windowsキー + R を押し、[ファイル名を指定して実行] ダイアログで `gpedit.msc` と入力してエンタキーを押します。（管理者権限で実行してください）

2. **スクリプト設定画面への移動:**
   左側のペインで次の順に展開します：
   `コンピュータの構成` → `Windows の設定` → `スクリプト (スタートアップ/シャットダウン)`

3. **シャットダウンスクリプトの追加:**
   - 右側の「シャットダウン」をダブルクリックします。
   - 「スクリプト」タブで「追加」ボタンをクリックし、実行するシャットダウン用の EXE（例：`C:\Program Files\PCActivityTracker\shutdown.exe`）のパスと必要な引数（通常は空欄）を指定します。

4. **保存と反映:**
   設定を保存して閉じ、実際にPCをシャットダウンまたは再起動して、スクリプトが自動実行されるかテストします。

---

どちらの方法も、目的に合わせて設定することで、PCの起動・終了時に自動的にログ記録が実行されるようになります。ご利用の環境に合わせて適切な方法を選択してください。


---

## 使い方

- **PC起動時:**
  - `startup.py`（またはEXE化した startup.exe）は起動時に実行され、PCのホスト名、ユーザー名、起動時刻、曜日などの情報を収集してネットワーク共有上のDBに保存します。

- **PC終了時:**
  - `shutdown.py`（または shutdown.exe）はシャットダウン時に実行され、最新の起動レコードを更新して、シャットダウン時刻と利用時間を記録します。

- **設定の変更:**
  - `config.ini` を編集することで、再試行回数、タイムアウト、DBのパス、そしてコンソール表示を簡単に切り替えられます。

---

## トラブルシューティング

- **データベースがロックされる場合:**
  再試行ロジックにより、自動的に再試行が行われますが、再試行回数が多くなる場合はネットワーク状況や他PCとの同時アクセスを確認してください。

- **ネットワーク共有接続エラー:**
  `config.ini` の `db_path` が正しく設定されているか、アクセス権限が適切か確認してください。

- **EXE化後に設定が変更できない場合:**
  設定ファイルはEXEとは別に配布し、同じディレクトリに配置することで、ユーザーが直接編集可能です。

---

## ライセンス

このプロジェクトは、[MIT License](https://opensource.org/licenses/MIT) の下でライセンスされています。

---

## 作者

- **kuroronrobins**
  GitHub: [https://github.com/kuroronrobins](https://github.com/kuroronrobins)

---

## お問い合わせ

ご質問、ご意見、バグ報告などは、GitHubのIssueまたはメールにてお知らせください。

---

PCActivityTrackerは、シンプルながら非常に強力なPC利用ログ管理ツールです。多くのPC環境での利用に最適な設計となっていますので、ぜひお試しください！